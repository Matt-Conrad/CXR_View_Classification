import pytest
import os
from expectedSizes import EXPECTED_NUM_FILES

def countDcms(folderName):
    return sum([len(files) for r, d, files in os.walk(folderName) if any(item.endswith('.dcm') for item in files)])

class TestFeatCalcStage:
    @pytest.fixture(autouse=True)
    def initFeatCalcStage(self, featCalcStage):
        self.featCalcStage = featCalcStage

    def test_tgzUnpackedBeforeStore(self):
        folderName = self.featCalcStage.featureCalculator.configHandler.getUnpackFolderPath()
        assert countDcms(folderName) == EXPECTED_NUM_FILES["subset"]

    def test_dbExists(self):
        assert self.featCalcStage.featureCalculator.dbHandler.dbExists(self.featCalcStage.featureCalculator.configHandler.getDbInfo()["database"])

    def test_metaTableExists(self):
        assert self.featCalcStage.featureCalculator.dbHandler.tableExists(self.featCalcStage.featureCalculator.configHandler.getTableName("metadata"))

    def test_featureTableNotExists(self):
        assert not self.featCalcStage.featureCalculator.dbHandler.tableExists(self.featCalcStage.featureCalculator.configHandler.getTableName("features"))

    def test_calculateFeatures(self):
        # Separate these asserts into multiple tests
        self.featCalcStage.featureCalculator.run()
        assert self.featCalcStage.featureCalculator.dbHandler.tableExists(self.featCalcStage.featureCalculator.configHandler.getTableName("features"))
        assert self.featCalcStage.featureCalculator.dbHandler.countRecords(self.featCalcStage.featureCalculator.configHandler.getTableName("features")) == EXPECTED_NUM_FILES["subset"]
        
        sqlQuery = 'SELECT * FROM ' + self.featCalcStage.featureCalculator.configHandler.getTableName("features") + ' ORDER BY file_name ASC;'
        cursor = self.featCalcStage.featureCalculator.dbHandler.executeQuery(self.featCalcStage.featureCalculator.dbHandler.connection, sqlQuery)
        record = cursor.fetchone()
        assert record["file_name"] == "1_IM-0001-3001.dcm"
        assert record["file_path"] == "NLMCXR_subset_dataset/NLMCXR_subset_dataset/1/1_IM-0001-3001.dcm"
        assert record["hor_profile"] == [0.2350319371971352, 0.25373674048824635, 0.26951557823188216, 0.2845463067926755, 0.2986563185957107, 0.31175751932995177, 0.3245961283985915, 0.3375099207864285, 0.34965072785499146, 0.3606767844584716, 0.37056421780410337, 0.38066243150291074, 0.3897733215991105, 0.3985820335951083, 0.4082716564069222, 0.41765465936818913, 0.42771397990152027, 0.43707171266461325, 0.4452695952571869, 0.453433265799922, 0.4620599352598928, 0.4685309796402096, 0.47519474181420784, 0.48224754371672723, 0.4886379997895924, 0.49541252388826257, 0.50330356140662, 0.5107447394137886, 0.5184205669641441, 0.5261982518702305, 0.5343756585288905, 0.5417471709040361, 0.548299854760533, 0.5559585078945459, 0.5636396291190088, 0.570620914947929, 0.5770441221990253, 0.5830287694022332, 0.5901279202726775, 0.5966435740163748, 0.6025423012869796, 0.6087439884492334, 0.6151563339219671, 0.6218114157614116, 0.628192121928615, 0.6356896230072588, 0.6421530608074966, 0.6473266927357932, 0.652319157893071, 0.6575662499634817, 0.6629074908824104, 0.6675251279869705, 0.6721508966919645, 0.6773632218115868, 0.6831686304760525, 0.6891103420411491, 0.6944157137187732, 0.6993851882045184, 0.7048381176310516, 0.7097175998903356, 0.714792686496424, 0.7195650765847112, 0.7244435421054867, 0.7287662285376634, 0.7326218461011984, 0.7372292688938025, 0.7415984389272552, 0.7462692170921418, 0.7509412492582977, 0.7560972123929637, 0.7600062882608474, 0.7653521051673015, 0.7714778636184448, 0.7765405201812499, 0.7808056196464864, 0.7850432050144016, 0.7895710960578216, 0.7935145388823063, 0.7961530684867958, 0.7990299549889659, 0.8017649895543804, 0.8052538993003355, 0.8090975183086213, 0.8122330402032765, 0.8157627190420699, 0.818772457317014, 0.8210353117576976, 0.822349573925178, 0.8236732666111606, 0.8251983221569662, 0.8265792834669616, 0.8279758639085351, 0.8290999712822957, 0.8290099620844847, 0.8273317860986813, 0.8256547072946558, 0.8248349300325437, 0.8249722344340619, 0.8251385022508911, 0.8248572972832285, 0.8239774673667267, 0.8214697449479117, 0.8194009603501385, 0.8176021072525718, 0.8162210339787968, 0.8151552943528358, 0.8149580765536267, 0.8153922542964787, 0.816481051998297, 0.8169950465232063, 0.8167563366778539, 0.8174284898544039, 0.8195153678459758, 0.8221720978412007, 0.8227972078003748, 0.8210116885493725, 0.8194572058682371, 0.8176578863408505, 0.8160792855721304, 0.8158571523601572, 0.8166115186832795, 0.8174261157104398, 0.817938136588931, 0.8187135729938407, 0.8171686688708061, 0.8164933406722966, 0.8147192047228369, 0.8138342440907086, 0.8129308574026033, 0.8100994000645118, 0.8084142990067155, 0.8082630121503652, 0.8081695725327327, 0.8080051472638449, 0.8084310973233975, 0.8096768968348051, 0.8113072310237325, 0.8115024962322428, 0.8135394247858752, 0.8160769952491742, 0.8182299721052552, 0.8215005922373086, 0.8212956562365961, 0.8215574735675075, 0.8217399844117321, 0.8212403943419571, 0.8227898650696801, 0.8239584067355902, 0.8253353423810116, 0.8264868423229688, 0.8272821250943245, 0.8289017695374745, 0.8297031541933667, 0.829400231460301, 0.8284982961873014, 0.8264046414186444, 0.8255112379985635, 0.8234834258502625, 0.8208666748534347, 0.8179731398265118, 0.8147059404451339, 0.811041636662147, 0.8059638369937581, 0.7990090880758463, 0.7914187644975132, 0.7826154542363559, 0.7736641173872808, 0.7640469521941062, 0.754008790836862, 0.7422842138646017, 0.730184633684107, 0.718079752709698, 0.7025186503593501, 0.683525356044798, 0.6656432505370172, 0.6475315293657031, 0.6293173613466643, 0.6105157121577407, 0.5906445554853867, 0.5709770756182351, 0.551085752983014, 0.5322105599339424, 0.5137623827702221, 0.4942562794893379, 0.47396720076753085, 0.4535646560331143, 0.4323025432174564, 0.4078813606439924, 0.3765346926994679, 0.3458542526571039, 0.3176535717925407, 0.2921603336410124, 0.2734442343258461, 0.2569822039524079, 0.24161896436505106, 0.22558227970753836, 0.20919526016028267, 0.19641366312959194, 0.1851382607132064, 0.1759794172035384]
        assert record["vert_profile"] == [0.6585307238995338, 0.654234802198452, 0.6512187756402058, 0.6486059086074778, 0.6469887305338341, 0.6469750899587338, 0.6463411217540872, 0.6453693165226055, 0.6436258512102009, 0.6411835770573612, 0.6381956090055434, 0.6349098101737887, 0.6308580615019104, 0.6272296209682726, 0.6213862541103936, 0.6157673479934528, 0.6082884211880214, 0.6033059476905318, 0.5983130786043191, 0.5929848108214857, 0.587295045565105, 0.5854091301504952, 0.5831113959207187, 0.5780815954761676, 0.574514447862187, 0.5761552526961522, 0.5785362656882727, 0.5794105105670713, 0.5806020312639019, 0.5873876497149252, 0.5780051038446561, 0.5760719922843793, 0.5770359944038103, 0.5777969334428106, 0.5764788316361117, 0.5754286161993103, 0.5768113537182472, 0.5770187999547147, 0.5772059522053946, 0.57735917569565, 0.5798657397057851, 0.5814094663294924, 0.5840669540477937, 0.5868673585347556, 0.5892283048271337, 0.5916408752981104, 0.5944159401950703, 0.5966278714358569, 0.5985764059313488, 0.6000818703463172, 0.6022520799399935, 0.6044625185252543, 0.6051490340777179, 0.6051630614589663, 0.6048403562511855, 0.6043530605547275, 0.6041242919874148, 0.6022787554746414, 0.6017617341913796, 0.6017051423804616, 0.60182029487626, 0.6024048658243912, 0.6022713483581655, 0.6017211765399934, 0.6007531641254684, 0.5994971505838887, 0.5981013337175274, 0.5966738520276748, 0.5962102763471099, 0.5971872330907222, 0.5987705785004069, 0.6005769634717931, 0.6038716637904834, 0.6070447338353061, 0.6059458658083925, 0.6050018572765908, 0.6040995754129611, 0.6035643734874094, 0.604313653140954, 0.606262446817188, 0.6085329120506046, 0.612908917018221, 0.6165399469839022, 0.6205788227040947, 0.6258213546364056, 0.6299410304505482, 0.6320842889173468, 0.6365729994422439, 0.6414975488583692, 0.6479277357610258, 0.6530508958342535, 0.6587571429719534, 0.6656818926366416, 0.6720795672392864, 0.6773370068382412, 0.6839577327612738, 0.6882969263019539, 0.6930013500758022, 0.6973114446783572, 0.6994716311054855, 0.7032358079922213, 0.7085817420333588, 0.7125071985336069, 0.7162464926278587, 0.7169827817254748, 0.7190576442952505, 0.7235046228942972, 0.724576975053515, 0.7251655023882337, 0.7255614938003092, 0.7264482329411125, 0.7262441945624605, 0.725502218544856, 0.7268469213766398, 0.727730293803531, 0.7250784246868391, 0.7239902608793676, 0.7243891798610236, 0.7251040449653096, 0.7224489058069529, 0.7199349025487578, 0.717855682135187, 0.7173830868933686, 0.7144634706023899, 0.7099711006905177, 0.7070886209826395, 0.7018453814692757, 0.6982977196056691, 0.6952438423623175, 0.694155861110923, 0.6898640890223976, 0.6838608735264954, 0.6780028548696648, 0.6738869314508925, 0.6695542564566724, 0.6657889221599643, 0.664805234031881, 0.668131689966601, 0.6680571861870945, 0.6702850092592277, 0.6743162772394611, 0.676277541213067, 0.6787898555242312, 0.6807544561783159, 0.6824310585901046, 0.6833984902726722, 0.6850792541072681, 0.6880114023320136, 0.6915261117533763, 0.6934087641958858, 0.6936346971696201, 0.6966409860934405, 0.7001117401362912, 0.7047074488157647, 0.7096354817044661, 0.711658445860785, 0.7125928238046623, 0.7137776780731631, 0.7152851430551906, 0.717732477842365, 0.7199744216868225, 0.7222649100991074, 0.7229911686369828, 0.7236890846283436, 0.725036015574254, 0.7268674998070479, 0.7285829056359868, 0.7297187572339483, 0.7310955929498985, 0.7320632839565263, 0.7333562097272592, 0.7346227437573046, 0.7358186954211463, 0.7362987260583447, 0.7373991651600176, 0.7387344527672013, 0.7395726263422064, 0.7400499951398858, 0.7405439320801483, 0.7411800855616605, 0.7423682150225613, 0.7433811371454985, 0.743734085572369, 0.7441120896478626, 0.7432177317384565, 0.7425016948828206, 0.7422473260679368, 0.7424392463347593, 0.7429704702005319, 0.7438323113829165, 0.7441431783266848, 0.7436518030928749, 0.7428525635897296, 0.7428260011399126, 0.7432496899853718, 0.7438333639578328, 0.7473522914447508, 0.7518162440685648, 0.7550628964385274, 0.7573147831401511]

        