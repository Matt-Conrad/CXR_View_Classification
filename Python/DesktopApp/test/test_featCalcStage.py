import pytest
import os
from expectedSizes import EXPECTED_SIZES, EXPECTED_NUM_FILES
import time

def countDcms(folderName):
    return sum([len(files) for r, d, files in os.walk(folderName) if any(item.endswith('.dcm') for item in files)])

class TestFeatCalcStage:
    @pytest.fixture(autouse=True)
    def initFeatCalcStage(self, featCalcStage):
        self.featCalcStage = featCalcStage
        os.chdir(self.featCalcStage.featureCalculator.configHandler.getParentFolder())

    def test_tgzUnpackedBeforeStore(self):
        folderName = self.featCalcStage.featureCalculator.configHandler.getDatasetName()
        assert countDcms(folderName) == EXPECTED_NUM_FILES["subset"]

    def test_dbExists(self):
        assert self.featCalcStage.featureCalculator.dbHandler.dbExists(self.featCalcStage.featureCalculator.configHandler.getDbInfo()["database"])

    def test_metaTableExists(self):
        assert self.featCalcStage.featureCalculator.dbHandler.tableExists(self.featCalcStage.featureCalculator.configHandler.getTableName("metadata"))

    def test_featureTableNotExists(self):
        assert not self.featCalcStage.featureCalculator.dbHandler.tableExists(self.featCalcStage.featureCalculator.configHandler.getTableName("features"))

    def test_calculateFeatures(self):
        # Separate these asserts into multiple tests
        self.featCalcStage.featureCalculator.run()
        assert self.featCalcStage.featureCalculator.dbHandler.tableExists(self.featCalcStage.featureCalculator.configHandler.getTableName("features"))
        assert self.featCalcStage.featureCalculator.dbHandler.countRecords(self.featCalcStage.featureCalculator.configHandler.getTableName("features")) == EXPECTED_NUM_FILES["subset"]
        
        sqlQuery = 'SELECT * FROM ' + self.featCalcStage.featureCalculator.configHandler.getTableName("features") + ' ORDER BY file_name ASC;'
        cursor = self.featCalcStage.featureCalculator.dbHandler.executeQuery(self.featCalcStage.featureCalculator.dbHandler.connection, sqlQuery)
        record = cursor.fetchone()
        assert record["file_name"] == "1_IM-0001-3001.dcm"
        assert record["file_path"] == "NLMCXR_subset_dataset/NLMCXR_subset_dataset/1/1_IM-0001-3001.dcm"
        assert record["hor_profile"] == [0.235031937197135, 0.253736740488246, 0.269515578231882, 0.284546306792676, 0.298656318595711, 0.311757519329952, 0.324596128398591, 0.337509920786428, 0.349650727854991, 0.360676784458472, 0.370564217804103, 0.380662431502911, 0.38977332159911, 0.398582033595108, 0.408271656406922, 0.417654659368189, 0.42771397990152, 0.437071712664613, 0.445269595257187, 0.453433265799922, 0.462059935259893, 0.46853097964021, 0.475194741814208, 0.482247543716727, 0.488637999789592, 0.495412523888263, 0.50330356140662, 0.510744739413789, 0.518420566964144, 0.526198251870231, 0.53437565852889, 0.541747170904036, 0.548299854760533, 0.555958507894546, 0.563639629119009, 0.570620914947929, 0.577044122199025, 0.583028769402233, 0.590127920272677, 0.596643574016375, 0.60254230128698, 0.608743988449233, 0.615156333921967, 0.621811415761412, 0.628192121928615, 0.635689623007259, 0.642153060807497, 0.647326692735793, 0.652319157893071, 0.657566249963482, 0.66290749088241, 0.667525127986971, 0.672150896691964, 0.677363221811587, 0.683168630476052, 0.689110342041149, 0.694415713718773, 0.699385188204518, 0.704838117631052, 0.709717599890336, 0.714792686496424, 0.719565076584711, 0.724443542105487, 0.728766228537663, 0.732621846101198, 0.737229268893802, 0.741598438927255, 0.746269217092142, 0.750941249258298, 0.756097212392964, 0.760006288260847, 0.765352105167301, 0.771477863618445, 0.77654052018125, 0.780805619646486, 0.785043205014402, 0.789571096057822, 0.793514538882306, 0.796153068486796, 0.799029954988966, 0.80176498955438, 0.805253899300336, 0.809097518308621, 0.812233040203276, 0.81576271904207, 0.818772457317014, 0.821035311757698, 0.822349573925178, 0.823673266611161, 0.825198322156966, 0.826579283466962, 0.827975863908535, 0.829099971282296, 0.829009962084485, 0.827331786098681, 0.825654707294656, 0.824834930032544, 0.824972234434062, 0.825138502250891, 0.824857297283229, 0.823977467366727, 0.821469744947912, 0.819400960350139, 0.817602107252572, 0.816221033978797, 0.815155294352836, 0.814958076553627, 0.815392254296479, 0.816481051998297, 0.816995046523206, 0.816756336677854, 0.817428489854404, 0.819515367845976, 0.822172097841201, 0.822797207800375, 0.821011688549372, 0.819457205868237, 0.81765788634085, 0.81607928557213, 0.815857152360157, 0.81661151868328, 0.81742611571044, 0.817938136588931, 0.818713572993841, 0.817168668870806, 0.816493340672297, 0.814719204722837, 0.813834244090709, 0.812930857402603, 0.810099400064512, 0.808414299006715, 0.808263012150365, 0.808169572532733, 0.808005147263845, 0.808431097323397, 0.809676896834805, 0.811307231023732, 0.811502496232243, 0.813539424785875, 0.816076995249174, 0.818229972105255, 0.821500592237309, 0.821295656236596, 0.821557473567508, 0.821739984411732, 0.821240394341957, 0.82278986506968, 0.82395840673559, 0.825335342381012, 0.826486842322969, 0.827282125094325, 0.828901769537475, 0.829703154193367, 0.829400231460301, 0.828498296187301, 0.826404641418644, 0.825511237998564, 0.823483425850262, 0.820866674853435, 0.817973139826512, 0.814705940445134, 0.811041636662147, 0.805963836993758, 0.799009088075846, 0.791418764497513, 0.782615454236356, 0.773664117387281, 0.764046952194106, 0.754008790836862, 0.742284213864602, 0.730184633684107, 0.718079752709698, 0.70251865035935, 0.683525356044798, 0.665643250537017, 0.647531529365703, 0.629317361346664, 0.610515712157741, 0.590644555485387, 0.570977075618235, 0.551085752983014, 0.532210559933942, 0.513762382770222, 0.494256279489338, 0.473967200767531, 0.453564656033114, 0.432302543217456, 0.407881360643992, 0.376534692699468, 0.345854252657104, 0.317653571792541, 0.292160333641012, 0.273444234325846, 0.256982203952408, 0.241618964365051, 0.225582279707538, 0.209195260160283, 0.196413663129592, 0.185138260713206, 0.175979417203538]
        assert record["vert_profile"] == [0.658530723899534, 0.654234802198452, 0.651218775640206, 0.648605908607478, 0.646988730533834, 0.646975089958734, 0.646341121754087, 0.645369316522606, 0.643625851210201, 0.641183577057361, 0.638195609005543, 0.634909810173789, 0.63085806150191, 0.627229620968273, 0.621386254110394, 0.615767347993453, 0.608288421188021, 0.603305947690532, 0.598313078604319, 0.592984810821486, 0.587295045565105, 0.585409130150495, 0.583111395920719, 0.578081595476168, 0.574514447862187, 0.576155252696152, 0.578536265688273, 0.579410510567071, 0.580602031263902, 0.587387649714925, 0.578005103844656, 0.576071992284379, 0.57703599440381, 0.577796933442811, 0.576478831636112, 0.57542861619931, 0.576811353718247, 0.577018799954715, 0.577205952205395, 0.57735917569565, 0.579865739705785, 0.581409466329492, 0.584066954047794, 0.586867358534756, 0.589228304827134, 0.59164087529811, 0.59441594019507, 0.596627871435857, 0.598576405931349, 0.600081870346317, 0.602252079939994, 0.604462518525254, 0.605149034077718, 0.605163061458966, 0.604840356251185, 0.604353060554727, 0.604124291987415, 0.602278755474641, 0.60176173419138, 0.601705142380462, 0.60182029487626, 0.602404865824391, 0.602271348358166, 0.601721176539993, 0.600753164125468, 0.599497150583889, 0.598101333717527, 0.596673852027675, 0.59621027634711, 0.597187233090722, 0.598770578500407, 0.600576963471793, 0.603871663790483, 0.607044733835306, 0.605945865808392, 0.605001857276591, 0.604099575412961, 0.603564373487409, 0.604313653140954, 0.606262446817188, 0.608532912050605, 0.612908917018221, 0.616539946983902, 0.620578822704095, 0.625821354636406, 0.629941030450548, 0.632084288917347, 0.636572999442244, 0.641497548858369, 0.647927735761026, 0.653050895834253, 0.658757142971953, 0.665681892636642, 0.672079567239286, 0.677337006838241, 0.683957732761274, 0.688296926301954, 0.693001350075802, 0.697311444678357, 0.699471631105485, 0.703235807992221, 0.708581742033359, 0.712507198533607, 0.716246492627859, 0.716982781725475, 0.719057644295251, 0.723504622894297, 0.724576975053515, 0.725165502388234, 0.725561493800309, 0.726448232941112, 0.72624419456246, 0.725502218544856, 0.72684692137664, 0.727730293803531, 0.725078424686839, 0.723990260879368, 0.724389179861024, 0.72510404496531, 0.722448905806953, 0.719934902548758, 0.717855682135187, 0.717383086893369, 0.71446347060239, 0.709971100690518, 0.707088620982639, 0.701845381469276, 0.698297719605669, 0.695243842362318, 0.694155861110923, 0.689864089022398, 0.683860873526495, 0.678002854869665, 0.673886931450893, 0.669554256456672, 0.665788922159964, 0.664805234031881, 0.668131689966601, 0.668057186187095, 0.670285009259228, 0.674316277239461, 0.676277541213067, 0.678789855524231, 0.680754456178316, 0.682431058590105, 0.683398490272672, 0.685079254107268, 0.688011402332014, 0.691526111753376, 0.693408764195886, 0.69363469716962, 0.69664098609344, 0.700111740136291, 0.704707448815765, 0.709635481704466, 0.711658445860785, 0.712592823804662, 0.713777678073163, 0.715285143055191, 0.717732477842365, 0.719974421686822, 0.722264910099107, 0.722991168636983, 0.723689084628344, 0.725036015574254, 0.726867499807048, 0.728582905635987, 0.729718757233948, 0.731095592949898, 0.732063283956526, 0.733356209727259, 0.734622743757305, 0.735818695421146, 0.736298726058345, 0.737399165160018, 0.738734452767201, 0.739572626342206, 0.740049995139886, 0.740543932080148, 0.74118008556166, 0.742368215022561, 0.743381137145498, 0.743734085572369, 0.744112089647863, 0.743217731738457, 0.742501694882821, 0.742247326067937, 0.742439246334759, 0.742970470200532, 0.743832311382917, 0.744143178326685, 0.743651803092875, 0.74285256358973, 0.742826001139913, 0.743249689985372, 0.743833363957833, 0.747352291444751, 0.751816244068565, 0.755062896438527, 0.757314783140151]

